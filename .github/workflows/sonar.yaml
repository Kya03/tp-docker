name: SonarCloud with Docker

on:
  push:
    branches:
      - master
      - ndack  # Active le test automatique sur ta branche de travail

jobs:
  build:
    if: github.repository_owner == 'kya03' 
    runs-on: ubuntu-latest

    steps:
      # 1. Récupération du code source
      - uses: actions/checkout@v3
        with:
          fetch-depth: 0 

      # 2. CONFIGURATION PRO : Installation de Java et Chrome sur GitHub
      - name: Set up JDK 17
        uses: actions/setup-java@v3
        with:
          java-version: 17
          distribution: zulu

      # Cette étape installe le navigateur nécessaire pour tes tests d'intégration
      - name: Setup Chrome for Integration Tests
        uses: browser-actions/setup-chrome@latest

      # 3. GÉNÉRATION DU RAPPORT : On lance les tests sur la machine GitHub
      # Cela évite les erreurs "command not found" du conteneur Docker
      - name: Run Tests and Generate Coverage
        run: |
          ./mvnw verify jacoco:report \
          -Dselenide.headless=true \
          -Dselenide.browser=chrome \
          -Dlicense.skip=true

      # 4. ANALYSE : Envoi des résultats à SonarCloud
      - name: Analyze with SonarCloud
        run: |
          ./mvnw sonar:sonar \
          -Dsonar.projectKey=kya03_tp-docker \
          -Dsonar.organization=kya03 \
          -Dsonar.host.url=https://sonarcloud.io \
          -Dsonar.login=${{ secrets.SONAR_TOKEN }} \
          -Dsonar.coverage.jacoco.xmlReportPaths=target/site/jacoco/jacoco.xml
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
